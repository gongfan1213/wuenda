### Letta框架中多代理协作（Multi-Agent Collaboration）的实现要点总结

#### 1. 多代理协作的核心机制
- **服务化部署**：Letta中的代理以服务形式运行，通过REST API与外部应用（如移动应用、网页）交互，支持跨服务的代理通信。  
- **协作方式**：  
  - **跨代理消息传递**：代理通过工具（如`send_message_to_agent`）向其他代理发送HTTP请求，实现直接通信。  
  - **共享内存块**：多个代理同步到同一内存块（存储于持久化数据库），实现信息共享（如公司信息、用户数据）。  


#### 2. 多代理协作场景示例：招聘工作流
- **场景目标**：评估潜在候选人并生成个性化 outreach 邮件，涉及两个代理：  
  - **评估代理（Evaluator Agent）**：判断候选人是否符合要求，决定是否推荐给外展代理。  
  - **外展代理（Outreach Agent）**：为通过评估的候选人起草邮件。  
- **共享资源**：  
  - 共享内存块（标签为“company”）：存储公司描述（如“Agent OS 专注于AI代理部署”），供两个代理访问。  


#### 3. 实现步骤

##### （1）创建共享内存块
- 通过客户端创建一个全局内存块，定义公司信息，并设置字符限制（如10,000字符）。  
  ```python  
  shared_block = client.blocks.create(  
      label="company",  
      value="Agent OS 部署AI工具简化LLM代理的创建与部署",  
      character_limit=10000  
  )  
  ```  
- 所有参与协作的代理均关联此内存块，确保信息同步。  


##### （2）定义代理与工具
- **外展代理**：  
  - 工具：`draft_candidate_email`（生成邮件草稿）。  
  - 内存块：包含自身角色描述（如“负责起草个性化邮件”）和共享内存块。  
  - 创建方式：通过`client.agents.create()`指定工具ID、共享内存块ID。  

- **评估代理**：  
  - 工具：`reject_candidate`（拒绝不合格候选人）、`send_message_to_agent`（向其他代理发送推荐信息）。  
  - 内存块：包含评估标准（如“优先考虑有前端开发和LLM经验的候选人”）和共享内存块。  
  - 行为约束：通过`tool_rules`设置“发送消息后终止执行”，避免无限循环。  


##### （3）跨代理通信流程
1. **评估代理处理候选人信息**：  
   - 接收候选人简历（如Tony Stark的简历），判断其符合要求。  
   - 调用`send_message_to_agent`工具，将候选人信息发送给外展代理，并附带外展代理的ID（预先在评估代理的角色描述中指定）。  

2. **外展代理生成邮件**：  
   - 接收评估代理的消息，调用`draft_candidate_email`工具生成邮件草稿。  
   - 通过`send_message`工具将结果返回给评估代理或用户。  


##### （4）共享内存块的同步机制
- 当任一代理修改共享内存块（如公司名称从“Agent OS”更名为“Letta”），所有关联该块的代理会自动同步更新，确保信息一致性。  
- 示例：外展代理调用`core_memory_replace`工具更新公司名称后，评估代理的内存块会同步显示新名称。  


#### 4. 多代理协作的另一种方式：代理组（Multi-Agent Group）
- **概念**：将多个代理加入同一“组”，共享单一对话历史，实现轮询式（round-robin）交互，无需显式工具即可通信。  
- **优势**：代理可直接查看组内所有消息（包括其他代理的回复），简化协作流程。  
- **示例**：  
  - 创建组并添加评估代理和外展代理。  
  - 向组发送候选人简历，代理按顺序处理：评估代理拒绝不合格者，外展代理为通过者起草邮件，所有操作记录在共享对话历史中。  


#### 5. 关键工具与配置
- **跨代理通信工具**：`send_message_to_agent_and_wait_for_reply`（内置工具），支持指定目标代理ID和消息内容。  
- **内存同步**：通过内存块ID关联多个代理，确保数据实时更新。  
- **行为约束**：使用`tool_rules`限制代理行为（如“发送消息后终止”），避免冗余操作。  


#### 6. 总结
- Letta支持两种多代理协作模式：**工具驱动的跨代理消息传递**（适用于分工明确、低频率通信）和**代理组共享对话历史**（适用于高频互动、信息透明场景）。  
- 共享内存块是实现信息一致性的核心，而工具则是代理间主动协作的桥梁。  
- 实际应用中可扩展至更复杂的多代理系统（如团队协作、流程自动化），通过组合共享内存和定制工具实现灵活分工。
