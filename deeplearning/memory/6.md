### 代理式RAG（Agentic RAG）与外部内存整合要点总结

#### 1. 代理式RAG与传统RAG的区别
- **核心差异**：  
  代理式RAG中，代理可自主决定**何时检索**（如判断是否需要外部信息）和**如何检索**（如定义查询关键词），而传统RAG的检索逻辑由人工预设。  
  - 例如：MemGPT代理会根据任务自动调用`archival_memory_search`，并自主生成查询词（如“dog”“vacation policies”）。


#### 2. 外部内存与RAG的关联
- **外部内存类型**：  
  - **归档内存（Archival Memory）**：通用外部存储，可由代理或用户手动添加数据（如文档、事实），用于长期存储非关键信息。  
  - **召回内存（Recall Memory）**：存储移出上下文窗口的对话历史，支持对话回溯检索。  
- **RAG实现方式**：  
  代理通过工具（如`archival_memory_search`）从外部内存中检索相关信息，整合到当前上下文以生成响应。


#### 3. 通过Letta框架整合外部数据的两种方式

##### （1）将数据复制到归档内存（基于数据源）
- **步骤**：  
  1. **创建数据源（Source）**：  
     定义一个包含特定嵌入模型（如OpenAI嵌入模型）的数据源，确保数据嵌入格式一致。  
     ```python  
     source = client.sources.create(name="employee_handbook", embedding_config={"model": "openai"})  
     ```  
  2. **上传文件到数据源**：  
     将文档（如PDF）上传到数据源，系统会自动解析为段落（passages）并生成嵌入。  
     ```python  
     job = client.sources.upload_file(source_id=source.id, file_path="handbook.pdf")  
     ```  
  3. **将数据源关联到代理**：  
     通过`attach`方法将数据源的段落复制到代理的归档内存，供代理检索。  
     ```python  
     client.agents.attach_source(agent_id=agent.id, source_id=source.id)  
     ```  
- **优势**：无需自定义工具，直接利用代理内置的`archival_memory_search`工具检索数据。


##### （2）通过自定义工具连接外部数据库
- **步骤**：  
  1. **定义工具**：  
     创建访问外部数据库的工具（如查询生日数据库的工具），工具内部实现数据库连接和查询逻辑。  
     ```python  
     def query_birthday_db(name: str):  
         """查询指定姓名的生日。"""  
         fake_db = {"Sarah": "1993-07-06"}  # 模拟数据库  
         return fake_db.get(name, "未找到")  
     ```  
  2. **注册工具并创建代理**：  
     将工具注册到Letta，并创建关联该工具的代理，确保代理可调用工具访问外部数据。  
     ```python  
     tool = client.tools.upsert_from_function(query_birthday_db)  
     agent = client.agents.create(tool_ids=[tool.id])  
     ```  
  3. **代理调用工具**：  
     代理接收用户查询（如“我的生日是什么时候？”）后，自动调用工具检索数据并生成响应。  
- **优势**：灵活对接自定义数据库或API，支持复杂检索逻辑（如带权限验证的内部系统）。


#### 4. 示例场景与效果
- **员工手册查询**：  
  代理通过`archival_memory_search`检索归档内存中的员工手册段落，回答关于休假政策的问题（如“休假需提供同等能力的AI代理代班”）。  
- **生日查询**：  
  代理调用`query_birthday_db`工具，从模拟数据库中获取用户生日并返回。  


#### 5. 关键总结
- Letta框架支持两种外部数据整合方式：**数据源复制到归档内存**（简单快捷）和**自定义工具连接外部系统**（灵活扩展）。  
- 代理式RAG的核心是代理的自主性，可动态决定检索策略，适用于需要长期记忆和复杂信息检索的场景（如客服、知识库问答）。  
- 实际应用中需注意嵌入模型一致性（避免检索误差）和敏感信息保护（如通过环境变量传递API密钥）。
